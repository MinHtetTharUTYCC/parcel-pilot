generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  MANAGER
  STAFF
  RESIDENT
  RESIDENT_PENDING
}

model User {
  id         String    @id @default(cuid())
  email      String    @unique
  password   String
  name       String
  phone      String?
  approvedAt DateTime? //for resident approval

  role       UserRole @default(RESIDENT_PENDING)
  unitNumber String? // For residents only

  imageUrl String?
  imageKey String? // R2 storage key

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  receivedParcels Parcel[]       @relation("ReceivedParcels")
  managedParcels  Parcel[]       @relation("ManagedParcels")
  pickupLogs      PickupLog[]
  notifications   Notification[]

  @@index([email])
  @@index([role])
  @@index([unitNumber])
}

enum ParcelStatus {
  REGISTERED
  READY_FOR_PICKUP // Resident notified
  PICKED_UP
  RETURNED
}

model Parcel {
  id String @id @default(cuid())

  orderId     String?
  description String?
  courier     String?

  imageUrl  String? // Direct R2 URL
  imageKey  String? // R2 storage key (parcels/{id}/image.jpg)
  imageSize Int? // size in bytes

  status ParcelStatus @default(REGISTERED)
  notes  String? // staff notes

  pickupCode String @unique @default(cuid()) // For QR code

  recipientId String // Resident receiving it
  recipient   User   @relation("ReceivedParcels", fields: [recipientId], references: [id])

  receivedById String // staff who registered it
  receivedBy   User   @relation("ManagedParcels", fields: [receivedById], references: [id])

  pickupLogs PickupLog[]

  registeredAt DateTime  @default(now())
  pickedUpAt   DateTime?

  @@index([recipientId])
  @@index([status])
  @@index([pickupCode])
  @@index([receivedById])
  @@index([registeredAt])
  @@index([orderId])
}

enum PickupMethod {
  QR_SCAN
  MANUAL_CODE // Resident entered code
  STAFF_VERIFIED // staff verified manually
}

model PickupLog {
  id String @id @default(cuid())

  parcelId String
  parcel   Parcel @relation(fields: [parcelId], references: [id])

  // Who picked up
  pickedById String // Resident who picked up
  pickedBy   User   @relation(fields: [pickedById], references: [id])

  // Pickup details
  method PickupMethod

  createdAt DateTime @default(now())

  @@index([parcelId])
  @@index([pickedById])
  @@index([createdAt])
}

enum NotificationType {
  PARCEL_RECEIVED
  PARCEL_READY
  PARCEL_PICKED_UP
  PICKUP_REMINDER
  ACCOUNT_APPROVED // Resident approved
  ACCOUNT_REJECTED // Resident rejected
}

model Notification {
  id String @id @default(cuid())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  // Notification content
  type     NotificationType
  title    String
  message  String
  metadata Json // { parcelId: "123", actionUrl: "/parcels/123" }

  isRead Boolean @default(false)

  actionUrl String?

  createdAt DateTime  @default(now())
  readAt    DateTime?

  // Indexes
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@index([type])
}
